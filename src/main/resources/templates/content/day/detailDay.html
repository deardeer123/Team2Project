<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{fragment/detail/detail_layout}">

<th:block layout:fragment="content_css">
    <!-- html 파일이 열릴때 같이 실행되는 css -->
    <link rel="stylesheet" href="/">
</th:block>

<th:block layout:fragment="contentFragment">
    <!-- html 코드 작성 -->
    <div class="row">
        <div class="col">
            <div class="row">
                <div class="col-1"></div>
                <div class="col-4 text-center ms-4">
                    <!-- 요일별 데이터 -->
                    <div>
                        <canvas id="mix-bar-chart" style="width: 30vh; height: 30vh;"></canvas>
                    </div>
                </div>

                <div class="col-5 mt-5 me-5 ms-3">
                    <div class="text-center fs-4">한국전기안전공사 연도별 감전사고 인명피해현황 요일별 데이터</div>
                    <table class="table table-hover table-bordered mt-4s">
                        <thead>
                            <tr>
                                <td class="text-center" style="background-color: #313A46; color: whitesmoke;"><svg
                                        xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor"
                                        class="bi bi-calendar" viewBox="0 0 16 16">
                                        <path
                                            d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z" />
                                    </svg></td>
                                <td class="fs-3" style="background-color: #3e95cd;">일</td>
                                <td class="fs-3" style="background-color: #8e5ea2;">월</td>
                                <td class="fs-3" style="background-color: #3cba9f;">화</td>
                                <td class="fs-3" style="background-color: #e8c3b9;">수</td>
                                <td class="fs-3" style="background-color: #c45850;">목</td>
                                <td class="fs-3" style="background-color: #8FA9CC;">금</td>
                                <td class="fs-3" style="background-color: #CC3AC5;">토</td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr onclick="changeChart('avg')">
                                <td>평균</td>
                                <td>[[${avgData.SUNDAY}]]</td>
                                <td>[[${avgData.MONDAY}]]</td>
                                <td>[[${avgData.TUESDAY}]]</td>
                                <td>[[${avgData.WEDNESDAY}]]</td>
                                <td>[[${avgData.THURSDAY}]]</td>
                                <td>[[${avgData.FRIDAY}]]</td>
                                <td>[[${avgData.SATURDAY}]]</td>
                            </tr>
                            <th:block th:each="e:${allData}">
                                <tr th:onclick="changeChart([[${e.occurredYear}]])">
                                    <td>[[${e.occurredYear}]]</td>
                                    <td>[[${e.sunday}]]</td>
                                    <td>[[${e.monday}]]</td>
                                    <td>[[${e.tuesday}]]</td>
                                    <td>[[${e.wednesday}]]</td>
                                    <td>[[${e.thursday}]]</td>
                                    <td>[[${e.friday}]]</td>
                                    <td>[[${e.saturday}]]</td>
                                </tr>
                            </th:block>
                        </tbody>

                    </table>
                    <div class="fs-2" id="data-div"></div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <!-- 시간별 데이터 -->
                    <div class="row">
                        <div class="col-1"></div>
                        <div class="col-4 text-center ms-4">
                            <div class="layer large-layer">
                                <canvas id="bar-chart" style="width: 30vh; height: 30vh;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <!-- chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Chart.defaults.global.defaultFontColor = 'white';
        new Chart(document.querySelector('#bar-chart'), {
            type: 'bar',
            data: {
                labels: ['a', 'b', 'c', 'd', 'e'],
                datasets: [
                    {
                        label: "최고기온",
                        backgroundColor: "#c45850",
                        data: [10.5, 11.5, 15.7, 8.5, 13.0]
                    },
                    {
                        label: "기온",
                        backgroundColor: "#3e95cd",
                        data: [3.1, 5.7, 1.2, 2.4, 3.5]
                    }
                ]
            },
            options: {
                legend: { display: true },
                title: {
                    display: true,
                    text: 'Predicted world population (millions) in 2050'
                },
                scales: {
                    y: {
                        min: 0,
                        max: 20
                    }
                }
            }
        });
        // 혼합 바차트
        let chart1 = new Chart(document.querySelector('#mix-bar-chart'), {
            type: 'bar',
            data: {
                datasets: [{
                    label: '막대형 데이터집합',
                    data: [10, 20, 30, 40, 50, 60, 70],
                    // 이 데이터집합은 아래에 그려집니다
                    order: 1
                }, {
                    label: '평균',
                    data: [10, 10, 10, 10, 10, 10, 10],
                    type: 'line',
                    // 이 데이터집합은 위에 그려집니다
                    order: 2
                }],
                labels: ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일']
            },
            options: {}
        });


        // //Doughnut chart
        // let chart1 = new Chart(document.querySelector('#doughnut-chart'), {
        //     type: 'doughnut',
        //     data: {
        //         labels: ["일", "월", "화", "수", "목", "금", "토"],
        //         datasets: [
        //             {
        //                 label: "피해인원 (명)",
        //                 backgroundColor: ["#3e95cd", "#8e5ea2", "#3cba9f", "#e8c3b9", "#c45850", "#8FA9CC", "#CC3AC5"],
        //                 data: [0, 1, 2, 3, 4, 5, 6]
        //             }
        //         ]
        //     },
        //     options: {
        //         title: {
        //             display: false,
        //             text: 'Predicted world population (millions) in 2050'
        //         }
        //     }
        // });
        changeChart('avg');

        function changeChart(avg) {
            console.log(avg)

            // ------------------- 첫번째 방식 ---------------//
            fetch(`/day/changeChart/${avg}`, { //요청경로
                method: 'POST',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                },
                //컨트롤러로 전달할 데이터
                body: new URLSearchParams({
                    // 데이터명 : 데이터값
                })
            })
                .then((response) => {
                    if (!response.ok) {
                        alert('fetch error!\n컨트롤러로 통신중에 오류가 발생했습니다.');
                        return;
                    }

                    //return response.text(); //컨트롤러에서 return하는 데이터가 없거나 int, String 일 때 사용
                    return response.json(); //나머지 경우에 사용
                })
                //fetch 통신 후 실행 영역
                .then((data) => {//data -> controller에서 리턴되는 데이터!
                    console.log(data)
                    let dataList = [];
                    dataList.push(data.SUNDAY)
                    dataList.push(data.MONDAY)
                    dataList.push(data.TUESDAY)
                    dataList.push(data.WEDNESDAY)
                    dataList.push(data.THURSDAY)
                    dataList.push(data.FRIDAY)
                    dataList.push(data.SATURDAY)

                    console.log(dataList)
                    chart1.destroy();

                    //선 그래프로 평균치를 표현하고 싶음
                    let avgDataList = []

                    //평균 구하기
                    let sum = 0;
                    for (let e of dataList) {
                        sum += e;
                    }
                    //소수점 1 아래 평균내기
                    let avgData = Math.ceil(sum / dataList.length * 10) / 10;

                    for (let i of dataList) {
                        // 그냥 요일 수 만큼 반복
                        avgDataList.push(avgData)
                    }

                    //혼합형 chart
                    chart1 = new Chart(document.querySelector('#mix-bar-chart'), {
                        type: 'bar',
                        data: {
                            datasets: [{
                                label: '인명피해현황(단위,명)',
                                data: dataList,
                                // 이 데이터집합은 아래에 그려집니다
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.2)',
                                    'rgba(255, 159, 64, 0.2)',
                                    'rgba(255, 205, 86, 0.2)',
                                    'rgba(75, 192, 192, 0.2)',
                                    'rgba(54, 162, 235, 0.2)',
                                    'rgba(153, 102, 255, 0.2)',
                                    'rgba(201, 203, 207, 0.2)'
                                ],
                                borderColor: [
                                    'rgb(255, 99, 132)',
                                    'rgb(255, 159, 64)',
                                    'rgb(255, 205, 86)',
                                    'rgb(75, 192, 192)',
                                    'rgb(54, 162, 235)',
                                    'rgb(153, 102, 255)',
                                    'rgb(201, 203, 207)'
                                ],
                                borderWidth: 1,
                                order: 1
                            }, {
                                label: '평균',
                                data: avgDataList,
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1,
                                fill: false,
                                type: 'line',
                                // 이 데이터집합은 위에 그려집니다
                                order: 2
                            }],
                            labels: ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일']
                        },
                        options: {
                            legend: {
                                labels: {
                                    fontColor: 'white'
                                }
                            },
                            scales: {
                                xAxes:[{
                                    ticks:{
                                        fontColor : 'white'
                                    },
                                    gridLines:{
                                        color:"whire"
                                    }
                                }],
                                yAxes: [{
                                    ticks:{
                                        fontColor:'white'
                                    }

                                }]
                            }

                        }
                    });

                    //무슨 요일에 사고가 많이 났는지 표현하기 위한 div
                    let dataDiv = document.querySelector("#data-div");
                    dataDiv.innerHTML = '';
                    let str = ``;

                    // 한국어로 표현된 요일을 넣기 위한 객체
                    let dayList = {
                        "MONDAY": "",
                        "TUESDAY": "",
                        "WEDNESDAY": "",
                        "THURSDAY": "",
                        "FRIDAY": "",
                        "SATURDAY": "",
                        "SUNDAY": ""

                    }
                    //평균낸 데이터와 받아온 데이터 비교하기
                    // Object.keys() -> 키 이름 가져오기
                    for (let e of Object.keys(data)) {
                        //요일 값이 평균값보다 높은경우 배열에 저장
                        if (data[e] > avgData) {
                            //한국어로 표현한 요일 넣기
                            switch (e) {
                                case "SUNDAY":
                                    dayList[e] = "일요일"
                                    break;
                                case "MONDAY":
                                    dayList[e] = "월요일"
                                    break;
                                case "TUESDAY":
                                    dayList[e] = "화요일";

                                    break;
                                case "WEDNESDAY":
                                    dayList[e] = "수요일";
                                    // dayList.push("수요일");
                                    break;
                                case "THURSDAY":
                                    dayList[e] = "목요일";
                                    // dayList.push("목요일");
                                    break;
                                case "FRIDAY":
                                    dayList[e] = "금요일";
                                    // dayList.push("금요일")
                                    break;
                                case "SATURDAY":
                                    dayList[e] = "토요일";
                                    // dayList.push("토요일")
                                    break;
                            }
                        }
                    }

                    console.log(dayList);
                    //avg문자열이 온경우는 평균적으로 으로 표현하고 싶음
                    if (avg == 'avg') {
                        str += `평균적으로 `
                    } else {
                        str += `${avg}년도에는 `
                    }
                    //평균치보다 사고가 많이 난 요일 div에 표현해주기
                    // dayList.forEach((i,idx)=>{
                    //     if(idx+1 == dayList.length){
                    //         str += `${i}`
                    //     }else{
                    //         str += `${i} ,`
                    //     }
                    // })

                    let korDayList = Object.keys(dayList)
                    korDayList.forEach((e, idx) => {
                        console.log(korDayList.length)
                        console.log(idx + 1)
                        if (dayList[e] != '') {
                            str += `${dayList[e]} ,`
                        }
                    })
                    str = str.slice(0, str.length - 2);
                    str += `에 사고가 많이 발생했습니다.`
                    dataDiv.insertAdjacentHTML("afterbegin", str);

                })
                //fetch 통신 실패 시 실행 영역
                .catch(err => {
                    alert('fetch error!\nthen 구문에서 오류가 발생했습니다.\n콘솔창을 확인하세요!');
                    console.log(err);
                });

        }


    </script>
</th:block>

<th:block layout:fragment="content_js">
    <!-- html 파일이 열릴때 같이 실행되는 js -->
    <!-- <script src="/"></script> -->
</th:block>

</html>